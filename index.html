<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ + Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¬Ù…ÙŠÙ„ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#79d6ff;
      --bg2:#eaf8ff;
      --glass: rgba(255,255,255,.68);
      --glass2: rgba(255,255,255,.52);
      --stroke: rgba(255,255,255,.55);
      --text: #0b1b2a;
      --muted:#3a546b;
      --danger:#c62828;
      --warn:#b26a00;
      --ok:#0a7a38;
      --shadow: 0 16px 50px rgba(0,0,0,.14);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    html,body{ height: 100%; }
    body{
      margin:0;
      font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x: hidden;
    }

    /* ===== Sky + Clouds ===== */
    #sky{
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events:none;
      overflow:hidden;
    }
    .sun{
      position:absolute;
      top: 40px;
      left: 70px;
      width: 170px;
      height: 170px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.95), rgba(255,225,130,.9), rgba(255,185,60,.55));
      filter: blur(.2px);
      opacity:.95;
      box-shadow: 0 0 90px rgba(255,220,120,.55);
    }
    .cloud{
      position:absolute;
      width: 220px;
      height: 62px;
      background: rgba(255,255,255,.80);
      border-radius: 40px;
      filter: blur(.2px);
      box-shadow: 0 14px 40px rgba(0,0,0,.06);
      opacity: .9;
    }
    .cloud::before,
    .cloud::after{
      content:"";
      position:absolute;
      background: inherit;
      border-radius: 50%;
    }
    .cloud::before{
      width: 88px; height: 88px;
      top: -44px; right: 40px;
    }
    .cloud::after{
      width: 62px; height: 62px;
      top: -30px; right: 108px;
    }

    @keyframes drift {
      from { transform: translateX(-260px); }
      to { transform: translateX(calc(100vw + 260px)); }
    }
    .c1{ top: 80px;  right: -260px; animation: drift 42s linear infinite; opacity:.85; }
    .c2{ top: 170px; right: -260px; animation: drift 58s linear infinite; opacity:.75; transform: translateX(-120px); }
    .c3{ top: 270px; right: -260px; animation: drift 75s linear infinite; opacity:.70; transform: translateX(-260px); }
    .c4{ top: 120px; right: -260px; animation: drift 95s linear infinite; opacity:.55; transform: translateX(-480px); }

    @media (prefers-reduced-motion: reduce){
      .c1,.c2,.c3,.c4{ animation: none; }
    }

    /* ===== App Layout ===== */
    .app{
      position: relative;
      z-index: 2;
      max-width: 1180px;
      margin: 0 auto;
      padding: 26px 16px 60px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .header h1{
      margin:0;
      font-size: 26px;
      letter-spacing: .2px;
    }
    .sub{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.7;
      max-width: 680px;
    }

    .header-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tabs{
      display:flex;
      gap: 10px;
      margin: 14px 0 18px;
      background: rgba(255,255,255,.40);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 999px;
      padding: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);
    }
    .tab{
      appearance:none;
      border:0;
      background: transparent;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 700;
      color: #234258;
      transition: transform .15s ease, background .15s ease;
      white-space: nowrap;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      background: rgba(255,255,255,.85);
      box-shadow: 0 12px 34px rgba(0,0,0,.08);
      color: #0b1b2a;
    }

    .tab-pane{ display:none; }
    .tab-pane.active{ display:block; }

    .panel{
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
      margin-bottom: 14px;
    }

    .panel h2{
      margin: 0 0 12px;
      font-size: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .field label{
      display:block;
      font-size: 13px;
      color: #2b4b62;
      margin-bottom: 6px;
      font-weight: 700;
    }
    input, select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(20,40,60,.18);
      background: rgba(255,255,255,.88);
      outline: none;
      font-family: inherit;
      transition: box-shadow .15s ease, transform .15s ease, border-color .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(60,130,180,.55);
      box-shadow: 0 0 0 4px rgba(80,160,210,.18);
    }
    .full{ grid-column: 1 / -1; }

    .row{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .between{ justify-content: space-between; }

    .btn{
      appearance: none;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.88);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 800;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      user-select: none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      background: rgba(255,255,255,.95);
    }
    .btn.primary{
      background: rgba(16,120,70,.92);
      color: #fff;
      border-color: rgba(16,120,70,.2);
    }
    .btn.primary:hover{ background: rgba(14,110,64,.98); }
    .btn.ghost{
      background: rgba(255,255,255,.45);
      border-color: rgba(255,255,255,.55);
    }

    .muted{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
      margin: 0;
    }

    .search{
      min-width: 220px;
      background: rgba(255,255,255,.82);
    }
    .select{
      min-width: 220px;
      background: rgba(255,255,255,.82);
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .card{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.08);
      transition: transform .18s ease;
    }
    .card:hover{ transform: translateY(-2px); }
    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .title{
      font-weight: 900;
      font-size: 16px;
      margin:0;
    }
    .badge{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.75);
      white-space: nowrap;
    }
    .badge.ok{ color: var(--ok); }
    .badge.warn{ color: var(--warn); }
    .badge.danger{ color: var(--danger); }

    .meta{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: #1a3346;
    }
    .meta a{
      color: #0b4a7c;
      text-decoration: none;
      font-weight: 800;
    }
    .meta a:hover{ text-decoration: underline; }

    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .actions .btn{
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 13px;
    }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.08);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(16,120,70,.85);
      transition: width .3s ease;
    }
    .bar.warn{ background: rgba(178,106,0,.85); }
    .bar.danger{ background: rgba(198,40,40,.85); }

    .pass{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .pass input{ flex: 1; }
    .icon{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.90);
      cursor:pointer;
      font-weight: 900;
    }

    .empty{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.55);
      border: 1px dashed rgba(0,0,0,.14);
    }

    /* Toasts */
    .toast-host{
      position: fixed;
      bottom: 18px;
      left: 18px;
      z-index: 99;
      display:flex;
      flex-direction: column;
      gap: 10px;
      max-width: min(420px, calc(100vw - 36px));
      pointer-events: none;
    }
    .toast{
      pointer-events: auto;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 16px 50px rgba(0,0,0,.16);
      backdrop-filter: blur(10px);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      animation: pop .18s ease;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
    .toast .t-emoji{ font-size: 18px; }
    .toast .t-text{ font-size: 13px; color:#173247; line-height: 1.7; }
    .toast .t-text b{ font-weight: 900; }

    /* Overlays / Modals */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(5,10,18,.30);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 120;
      backdrop-filter: blur(6px);
    }
    .overlay-card{
      width: min(520px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 20px;
      box-shadow: 0 22px 70px rgba(0,0,0,.22);
      padding: 16px;
    }
    .overlay-card h3{ margin: 0 0 8px; }
    .overlay-card form{
      display:flex;
      gap: 10px;
      flex-direction: column;
      margin-top: 10px;
    }
    .error{
      color: var(--danger);
      font-weight: 900;
      margin-top: 10px;
      font-size: 13px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .search, .select{ min-width: 0; width: 100%; }
      .header{ flex-direction: column; }
      .header-actions{ justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <div id="sky" aria-hidden="true">
    <div class="sun"></div>
    <div class="cloud c1"></div>
    <div class="cloud c2"></div>
    <div class="cloud c3"></div>
    <div class="cloud c4"></div>
  </div>

  <div class="app">
    <div class="header">
      <div>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ + Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</h1>
        <p class="sub">
          âœ… Ù…Ø¯Ø© ÙƒÙ„ Ù…Ø³Ø§Ø­Ø© = <b>30 ÙŠÙˆÙ…</b> Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©<br>
          ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ <b>Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯</b><br>
          ğŸ”’ ØªÙ‚Ø¯Ø± ØªÙ‚ÙÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ´ÙÙŠØ±) Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ©
        </p>
      </div>

      <div class="header-actions">
        <button id="btnLock" class="btn ghost" title="Ù‚ÙÙ„/ÙÙƒ Ù‚ÙÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”’ Ù‚ÙÙ„</button>
        <button id="btnExport" class="btn ghost" title="ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
        <label for="importFile" class="btn ghost" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
        <input id="importFile" type="file" accept="application/json" hidden>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="workspaces">Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„</button>
      <button class="tab" data-tab="vault">Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯</button>
    </div>

    <main>
      <!-- Workspaces -->
      <section id="tab-workspaces" class="tab-pane active">
        <div class="panel">
          <h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„</h2>

          <form id="wsForm" autocomplete="off">
            <div class="grid">
              <div class="field">
                <label>Ø£Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
                <input id="wsName" required placeholder="Ù…Ø«Ù„Ø§Ù‹: Workspace 1">
              </div>

              <div class="field">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
                <input id="wsUrl" type="url" required placeholder="https://...">
              </div>

              <div class="field">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="wsEmailUrl" type="url" placeholder="https://mail.google.com/">
              </div>

              <div class="field">
                <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                <input id="wsEmail" type="email" required placeholder="name@example.com">
              </div>

              <div class="field">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (ÙŠØ­Ø³Ø¨ 30 ÙŠÙˆÙ…)</label>
                <input id="wsStart" type="date" required>
              </div>

              <div class="field">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ…)</label>
                <input id="wsEnd" type="date" readonly>
              </div>
            </div>

            <div class="row">
              <button type="submit" id="wsSubmit" class="btn primary">â• Ø¥Ø¶Ø§ÙØ©</button>
              <button type="button" id="wsCancel" class="btn" hidden>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
          </form>
        </div>

        <div class="panel">
          <div class="row between">
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª</h2>
            <div class="row" style="margin-top:0;">
              <input id="wsSearch" class="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„...">
              <select id="wsFilter" class="select" title="ÙÙ„ØªØ±Ø©">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="soon">ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (â‰¤ 3 Ø£ÙŠØ§Ù…)</option>
                <option value="active">Ù†Ø´Ø·Ø©</option>
                <option value="expired">Ù…Ù†ØªÙ‡ÙŠØ©</option>
              </select>
            </div>
          </div>

          <div id="wsList" class="cards"></div>
          <p id="wsEmpty" class="muted empty" hidden>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø§Øª Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø³Ø§Ø­Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>
        </div>
      </section>

      <!-- Vault -->
      <section id="tab-vault" class="tab-pane">
        <div class="panel">
          <h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ¨Ø§Ø³ÙˆØ±Ø¯</h2>

          <form id="vaultForm" autocomplete="off">
            <div class="grid">
              <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <input id="vService" required placeholder="Ù…Ø«Ù„Ø§Ù‹: ChatGPT Ø³Ù†ÙˆÙŠ">
              </div>

              <div class="field">
                <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                <input id="vEmail" required placeholder="Ù…Ø«Ù„Ø§Ù‹: my@email.com">
              </div>

              <div class="field">
                <label>ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                <div class="pass">
                  <input id="vPassEmail" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                  <button type="button" class="icon" data-toggle="#vPassEmail" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</button>
                  <button type="button" class="icon" data-copy="#vPassEmail" title="Ù†Ø³Ø®">ğŸ“‹</button>
                </div>
              </div>

              <div class="field">
                <label>ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø®Ø¯Ù…Ø© (ChatGPT / Gemini)</label>
                <div class="pass">
                  <input id="vPassService" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                  <button type="button" class="icon" data-toggle="#vPassService" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</button>
                  <button type="button" class="icon" data-copy="#vPassService" title="Ù†Ø³Ø®">ğŸ“‹</button>
                </div>
              </div>

              <div class="field full">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="vNote" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ù†ÙˆÙŠ - Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø± 12">
              </div>
            </div>

            <div class="row">
              <button type="submit" id="vaultSubmit" class="btn primary">â• Ø¥Ø¶Ø§ÙØ©</button>
              <button type="button" id="vaultCancel" class="btn" hidden>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
          </form>
        </div>

        <div class="panel">
          <div class="row between">
            <h2>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            <div class="row" style="margin-top:0;">
              <input id="vSearch" class="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„...">
            </div>
          </div>

          <div id="vaultList" class="cards"></div>
          <p id="vaultEmpty" class="muted empty" hidden>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>
        </div>
      </section>
    </main>
  </div>

  <div id="toastHost" class="toast-host" aria-live="polite" aria-atomic="true"></div>

  <!-- Locked Overlay -->
  <div id="lockOverlay" class="overlay" hidden>
    <div class="overlay-card">
      <h3>ğŸ” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‚ÙÙˆÙ„Ø©</h3>
      <p class="muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
      <form id="unlockForm">
        <input id="unlockPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" required>
        <button class="btn primary" type="submit">ÙØªØ­</button>
      </form>
      <p id="unlockError" class="error" hidden>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ©.</p>
    </div>
  </div>

  <!-- Set Master Password Modal -->
  <div id="modal" class="overlay" hidden>
    <div class="overlay-card">
      <h3 id="modalTitle">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
      <p id="modalText" class="muted">Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ø§ ØªÙ†Ø³Ù‡Ø§).</p>

      <form id="modalForm">
        <input id="mp1" type="password" minlength="8" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±)">
        <input id="mp2" type="password" minlength="8" required placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div class="row">
          <button class="btn primary" type="submit">ØªØ£ÙƒÙŠØ¯</button>
          <button class="btn" type="button" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>

      <p id="modalError" class="error" hidden>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
    </div>
  </div>

  <script>
    "use strict";

    const STORAGE_KEY = "WS_VAULT_STORE_V1";
    const MS_DAY = 24 * 60 * 60 * 1000;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const ui = {
      tabs: $$(".tab"),
      paneWorkspaces: $("#tab-workspaces"),
      paneVault: $("#tab-vault"),

      btnLock: $("#btnLock"),
      btnExport: $("#btnExport"),
      importFile: $("#importFile"),

      // Workspace form
      wsForm: $("#wsForm"),
      wsName: $("#wsName"),
      wsUrl: $("#wsUrl"),
      wsEmailUrl: $("#wsEmailUrl"),
      wsEmail: $("#wsEmail"),
      wsStart: $("#wsStart"),
      wsEnd: $("#wsEnd"),
      wsSubmit: $("#wsSubmit"),
      wsCancel: $("#wsCancel"),
      wsSearch: $("#wsSearch"),
      wsFilter: $("#wsFilter"),
      wsList: $("#wsList"),
      wsEmpty: $("#wsEmpty"),

      // Vault form
      vaultForm: $("#vaultForm"),
      vService: $("#vService"),
      vEmail: $("#vEmail"),
      vPassEmail: $("#vPassEmail"),
      vPassService: $("#vPassService"),
      vNote: $("#vNote"),
      vaultSubmit: $("#vaultSubmit"),
      vaultCancel: $("#vaultCancel"),
      vSearch: $("#vSearch"),
      vaultList: $("#vaultList"),
      vaultEmpty: $("#vaultEmpty"),

      toastHost: $("#toastHost"),

      lockOverlay: $("#lockOverlay"),
      unlockForm: $("#unlockForm"),
      unlockPassword: $("#unlockPassword"),
      unlockError: $("#unlockError"),

      modal: $("#modal"),
      modalForm: $("#modalForm"),
      modalCancel: $("#modalCancel"),
      modalTitle: $("#modalTitle"),
      modalText: $("#modalText"),
      modalError: $("#modalError"),
      mp1: $("#mp1"),
      mp2: $("#mp2"),
    };

    function toLocalISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseISO(iso){
      // iso: YYYY-MM-DD (local midnight)
      return new Date(iso + "T00:00:00");
    }
    function formatDateAr(iso){
      const d = parseISO(iso);
      return d.toLocaleDateString("ar", { year:"numeric", month:"long", day:"numeric" });
    }
    function uid(prefix="id"){
      if (crypto && crypto.randomUUID) return `${prefix}_${crypto.randomUUID()}`;
      return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function toast(message, emoji="âœ¨"){
      const node = document.createElement("div");
      node.className = "toast";
      node.innerHTML = `<div class="t-emoji">${emoji}</div><div class="t-text">${message}</div>`;
      ui.toastHost.appendChild(node);
      setTimeout(() => {
        node.style.opacity = "0";
        node.style.transform = "translateY(8px)";
        setTimeout(() => node.remove(), 250);
      }, 4200);
    }

    async function copyText(text){
      try{
        if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(_){}
      // fallback
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      }catch(_){
        return false;
      }
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function computeExpiry(startISO){
      const start = parseISO(startISO);
      const end = new Date(start.getTime() + 30 * MS_DAY);
      return toLocalISO(end);
    }
    function daysLeftFromEnd(endISO){
      const today = parseISO(toLocalISO(new Date()));
      const end = parseISO(endISO);
      const diff = (end.getTime() - today.getTime()) / MS_DAY;
      return Math.ceil(diff);
    }

    function defaultState(){
      return {
        workspaces: [],
        vault: [],
        alerts: {}, // { workspaceId: "YYYY-MM-DD" last shown }
        ui: { activeTab: "workspaces" }
      };
    }

    // ===== Encryption (Optional) =====
    const encryption = {
      enabled: false,
      key: null,
      saltB64: null
    };
    let lockedBlob = null; // {mode:'enc', salt, iv, cipher}

    function bufToB64(buf){
      const bytes = new Uint8Array(buf);
      let bin = "";
      for (const b of bytes) bin += String.fromCharCode(b);
      return btoa(bin);
    }
    function b64ToBuf(b64){
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
      return bytes.buffer;
    }

    async function deriveKey(password, saltB64){
      const enc = new TextEncoder();
      const salt = saltB64
        ? new Uint8Array(b64ToBuf(saltB64))
        : crypto.getRandomValues(new Uint8Array(16));

      const baseKey = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        "PBKDF2",
        false,
        ["deriveKey"]
      );

      const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 150000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );

      return { key, saltB64: bufToB64(salt.buffer) };
    }

    async function encryptJson(key, data){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder();
      const plain = enc.encode(JSON.stringify(data));
      const cipherBuf = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, plain);
      return { ivB64: bufToB64(iv.buffer), cipherB64: bufToB64(cipherBuf) };
    }

    async function decryptJson(key, ivB64, cipherB64){
      const iv = new Uint8Array(b64ToBuf(ivB64));
      const cipherBuf = b64ToBuf(cipherB64);
      const plainBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, cipherBuf);
      const dec = new TextDecoder();
      return JSON.parse(dec.decode(plainBuf));
    }

    // ===== Persistence =====
    let state = defaultState();
    let saving = false;
    let pendingSave = false;

    function mergeDefaults(data){
      const def = defaultState();
      if (!data || typeof data !== "object") return def;
      return {
        workspaces: Array.isArray(data.workspaces) ? data.workspaces : [],
        vault: Array.isArray(data.vault) ? data.vault : [],
        alerts: data.alerts && typeof data.alerts === "object" ? data.alerts : {},
        ui: { activeTab: data.ui && data.ui.activeTab === "vault" ? "vault" : "workspaces" }
      };
    }

    function loadRaw(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try{ return JSON.parse(raw); }catch(_){ return null; }
    }

    async function persist(){
      if (saving){ pendingSave = true; return; }
      saving = true;

      try{
        const payload = { v: 1, updatedAt: Date.now() };

        if (encryption.enabled){
          const { ivB64, cipherB64 } = await encryptJson(encryption.key, state);
          payload.mode = "enc";
          payload.salt = encryption.saltB64;
          payload.iv = ivB64;
          payload.cipher = cipherB64;
        }else{
          payload.mode = "plain";
          payload.data = state;
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){
        console.error(e);
        toast("ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸. Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.", "âš ï¸");
      }finally{
        saving = false;
        if (pendingSave){
          pendingSave = false;
          persist();
        }
      }
    }

    // ===== UI helpers =====
    let editingWsId = null;
    let editingVaultId = null;

    function setTab(name){
      state.ui.activeTab = name;
      ui.tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      ui.paneWorkspaces.classList.toggle("active", name === "workspaces");
      ui.paneVault.classList.toggle("active", name === "vault");
      persist();
    }

    function updateLockButton(){
      if (encryption.enabled){
        ui.btnLock.textContent = "ğŸ”“ ÙÙƒ Ø§Ù„Ù‚ÙÙ„";
        ui.btnLock.title = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ´ÙÙŠØ± (ÙŠØ­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ù‚ÙÙ„)";
      }else{
        ui.btnLock.textContent = "ğŸ”’ Ù‚ÙÙ„";
        ui.btnLock.title = "ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ©";
      }
    }

    function badgeForDays(daysLeft){
      if (daysLeft <= 0) return { cls:"danger", text:"Ù…Ù†ØªÙ‡ÙŠØ©" };
      if (daysLeft === 1) return { cls:"warn", text:"ØªÙ†ØªÙ‡ÙŠ ØºØ¯Ø§Ù‹" };
      if (daysLeft <= 3) return { cls:"warn", text:`Ù‚Ø±ÙŠØ¨Ø© (${daysLeft} Ø£ÙŠØ§Ù…)` };
      return { cls:"ok", text:`Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…` };
    }

    function progressForDays(daysLeft){
      // 30 days total
      const pct = clamp((daysLeft / 30) * 100, 0, 100);
      let cls = "";
      if (daysLeft <= 0) cls = "danger";
      else if (daysLeft <= 3) cls = "warn";
      return { pct, cls };
    }

    function renderWorkspaces(){
      const term = (ui.wsSearch.value || "").trim().toLowerCase();
      const filter = ui.wsFilter.value;

      const items = state.workspaces
        .map(ws => {
          const endISO = computeExpiry(ws.startISO);
          const daysLeft = daysLeftFromEnd(endISO);
          return { ...ws, endISO, daysLeft };
        })
        .filter(ws => {
          const hay = `${ws.name} ${ws.email}`.toLowerCase();
          if (term && !hay.includes(term)) return false;

          if (filter === "soon") return ws.daysLeft > 0 && ws.daysLeft <= 3;
          if (filter === "active") return ws.daysLeft > 0;
          if (filter === "expired") return ws.daysLeft <= 0;
          return true;
        })
        .sort((a,b) => (a.daysLeft - b.daysLeft) || a.name.localeCompare(b.name, "ar"));

      ui.wsList.innerHTML = "";
      ui.wsEmpty.hidden = items.length !== 0;

      for (const ws of items){
        const badge = badgeForDays(ws.daysLeft);
        const prog = progressForDays(ws.daysLeft);

        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "card-top";

        const title = document.createElement("p");
        title.className = "title";
        title.textContent = ws.name;

        const b = document.createElement("span");
        b.className = `badge ${badge.cls}`;
        b.textContent = badge.text;

        top.appendChild(title);
        top.appendChild(b);

        const meta = document.createElement("div");
        meta.className = "meta";

        const endLine = document.createElement("div");
        endLine.innerHTML = `ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <b>${formatDateAr(ws.endISO)}</b> â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b>${Math.max(ws.daysLeft, 0)}</b> ÙŠÙˆÙ…`;
        meta.appendChild(endLine);

        const linkLine = document.createElement("div");
        linkLine.innerHTML = `ğŸ”— <a href="${ws.workspaceUrl}" target="_blank" rel="noopener">ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø­Ø©</a>`;
        meta.appendChild(linkLine);

        const emailLine = document.createElement("div");
        const mailto = `mailto:${ws.email}`;
        emailLine.innerHTML = `ğŸ“§ <a href="${mailto}" target="_blank" rel="noopener">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</a> â€” <b>${ws.email}</b>`;
        meta.appendChild(emailLine);

        if (ws.emailUrl && ws.emailUrl.trim()){
          const emailUrlLine = document.createElement("div");
          emailUrlLine.innerHTML = `ğŸ” <a href="${ws.emailUrl}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</a>`;
          meta.appendChild(emailUrlLine);
        }

        const progress = document.createElement("div");
        progress.className = "progress";
        const bar = document.createElement("div");
        bar.className = `bar ${prog.cls}`;
        bar.style.width = `${prog.pct}%`;
        progress.appendChild(bar);

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnCopyEmail = document.createElement("button");
        btnCopyEmail.className = "btn";
        btnCopyEmail.textContent = "ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„";
        btnCopyEmail.addEventListener("click", async () => {
          const ok = await copyText(ws.email);
          toast(ok ? "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ âœ…" : "ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® (Ø¬Ø±Ù‘Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§).", ok ? "âœ…" : "âš ï¸");
        });

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn";
        btnEdit.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
        btnEdit.addEventListener("click", () => {
          editingWsId = ws.id;
          ui.wsName.value = ws.name;
          ui.wsUrl.value = ws.workspaceUrl;
          ui.wsEmailUrl.value = ws.emailUrl || "";
          ui.wsEmail.value = ws.email;
          ui.wsStart.value = ws.startISO;
          ui.wsEnd.value = computeExpiry(ws.startISO);
          ui.wsSubmit.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
          ui.wsCancel.hidden = false;
          toast("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØºÙŠÙ‘Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.", "âœï¸");
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const btnDel = document.createElement("button");
        btnDel.className = "btn";
        btnDel.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù";
        btnDel.addEventListener("click", () => {
          const ok = confirm(`Ø­Ø°Ù Ù…Ø³Ø§Ø­Ø©: ${ws.name} ØŸ`);
          if (!ok) return;
          state.workspaces = state.workspaces.filter(x => x.id !== ws.id);
          persist();
          renderWorkspaces();
          toast("ØªÙ… Ø§Ù„Ø­Ø°Ù.", "ğŸ—‘ï¸");
        });

        actions.appendChild(btnCopyEmail);
        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(progress);
        card.appendChild(actions);

        ui.wsList.appendChild(card);
      }
    }

    function renderVault(){
      const term = (ui.vSearch.value || "").trim().toLowerCase();

      const items = state.vault
        .filter(v => {
          const hay = `${v.service} ${v.email} ${v.note || ""}`.toLowerCase();
          if (term && !hay.includes(term)) return false;
          return true;
        })
        .sort((a,b) => a.service.localeCompare(b.service, "ar"));

      ui.vaultList.innerHTML = "";
      ui.vaultEmpty.hidden = items.length !== 0;

      for (const v of items){
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "card-top";

        const title = document.createElement("p");
        title.className = "title";
        title.textContent = v.service;

        const b = document.createElement("span");
        b.className = "badge ok";
        b.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø®";

        top.appendChild(title);
        top.appendChild(b);

        const meta = document.createElement("div");
        meta.className = "meta";

        const emailLine = document.createElement("div");
        emailLine.innerHTML = `ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <b>${v.email}</b>`;
        meta.appendChild(emailLine);

        if (v.note && v.note.trim()){
          const noteLine = document.createElement("div");
          noteLine.innerHTML = `ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: <b>${v.note}</b>`;
          meta.appendChild(noteLine);
        }

        const actions = document.createElement("div");
        actions.className = "actions";

        const mkCopyBtn = (label, value) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = label;
          btn.addEventListener("click", async () => {
            const ok = await copyText(value);
            toast(ok ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…" : "ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®.", ok ? "âœ…" : "âš ï¸");
          });
          return btn;
        };

        actions.appendChild(mkCopyBtn("ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", v.email));
        actions.appendChild(mkCopyBtn("ğŸ“‹ Ù†Ø³Ø® ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", v.passEmail));
        actions.appendChild(mkCopyBtn("ğŸ“‹ Ù†Ø³Ø® ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø®Ø¯Ù…Ø©", v.passService));

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn";
        btnEdit.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
        btnEdit.addEventListener("click", () => {
          editingVaultId = v.id;
          ui.vService.value = v.service;
          ui.vEmail.value = v.email;
          ui.vPassEmail.value = v.passEmail;
          ui.vPassService.value = v.passService;
          ui.vNote.value = v.note || "";
          ui.vaultSubmit.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
          ui.vaultCancel.hidden = false;
          setTab("vault");
          toast("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØºÙŠÙ‘Ø± Ø«Ù… Ø§Ø­ÙØ¸.", "âœï¸");
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const btnDel = document.createElement("button");
        btnDel.className = "btn";
        btnDel.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù";
        btnDel.addEventListener("click", () => {
          const ok = confirm(`Ø­Ø°Ù: ${v.service} ØŸ`);
          if (!ok) return;
          state.vault = state.vault.filter(x => x.id !== v.id);
          persist();
          renderVault();
          toast("ØªÙ… Ø§Ù„Ø­Ø°Ù.", "ğŸ—‘ï¸");
        });

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(actions);

        ui.vaultList.appendChild(card);
      }
    }

    function checkExpiryAlerts(){
      const todayISO = toLocalISO(new Date());
      let triggered = 0;

      for (const ws of state.workspaces){
        const endISO = computeExpiry(ws.startISO);
        const daysLeft = daysLeftFromEnd(endISO);

        if (daysLeft === 1){
          const last = state.alerts[ws.id];
          if (last !== todayISO){
            state.alerts[ws.id] = todayISO;
            triggered++;
            toast(`ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø³Ø§Ø­Ø© <b>${ws.name}</b> ØªÙ†ØªÙ‡ÙŠ <b>ØºØ¯Ø§Ù‹</b>.`, "ğŸ””");
          }
        }
      }

      if (triggered > 0) persist();
    }

    // ===== Events =====
    ui.tabs.forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    ui.wsStart.addEventListener("change", () => {
      ui.wsEnd.value = computeExpiry(ui.wsStart.value);
    });

    ui.wsForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const obj = {
        id: editingWsId || uid("ws"),
        name: ui.wsName.value.trim(),
        workspaceUrl: ui.wsUrl.value.trim(),
        emailUrl: ui.wsEmailUrl.value.trim(),
        email: ui.wsEmail.value.trim(),
        startISO: ui.wsStart.value
      };

      if (!obj.name || !obj.workspaceUrl || !obj.email || !obj.startISO){
        toast("ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.", "âš ï¸");
        return;
      }

      if (editingWsId){
        const i = state.workspaces.findIndex(x => x.id === editingWsId);
        if (i >= 0) state.workspaces[i] = obj;
        editingWsId = null;
        ui.wsSubmit.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
        ui.wsCancel.hidden = true;
        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "âœ…");
      }else{
        state.workspaces.push(obj);
        toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…", "âœ…");
      }

      persist();
      ui.wsForm.reset();

      // restore defaults
      ui.wsStart.value = toLocalISO(new Date());
      ui.wsEnd.value = computeExpiry(ui.wsStart.value);

      renderWorkspaces();
      checkExpiryAlerts();
    });

    ui.wsCancel.addEventListener("click", () => {
      editingWsId = null;
      ui.wsSubmit.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
      ui.wsCancel.hidden = true;
      ui.wsForm.reset();
      ui.wsStart.value = toLocalISO(new Date());
      ui.wsEnd.value = computeExpiry(ui.wsStart.value);
      toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.", "â†©ï¸");
    });

    ui.wsSearch.addEventListener("input", () => renderWorkspaces());
    ui.wsFilter.addEventListener("change", () => renderWorkspaces());

    ui.vaultForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const obj = {
        id: editingVaultId || uid("v"),
        service: ui.vService.value.trim(),
        email: ui.vEmail.value.trim(),
        passEmail: ui.vPassEmail.value,
        passService: ui.vPassService.value,
        note: ui.vNote.value.trim()
      };

      if (!obj.service || !obj.email || !obj.passEmail || !obj.passService){
        toast("ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.", "âš ï¸");
        return;
      }

      if (editingVaultId){
        const i = state.vault.findIndex(x => x.id === editingVaultId);
        if (i >= 0) state.vault[i] = obj;
        editingVaultId = null;
        ui.vaultSubmit.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
        ui.vaultCancel.hidden = true;
        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "âœ…");
      }else{
        state.vault.push(obj);
        toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…", "âœ…");
      }

      persist();
      ui.vaultForm.reset();
      renderVault();
    });

    ui.vaultCancel.addEventListener("click", () => {
      editingVaultId = null;
      ui.vaultSubmit.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
      ui.vaultCancel.hidden = true;
      ui.vaultForm.reset();
      toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.", "â†©ï¸");
    });

    ui.vSearch.addEventListener("input", () => renderVault());

    // toggle show/hide + copy from form icons
    document.addEventListener("click", async (e) => {
      const t = e.target;

      if (t && t.matches("[data-toggle]")){
        const sel = t.getAttribute("data-toggle");
        const input = $(sel);
        if (!input) return;
        input.type = (input.type === "password") ? "text" : "password";
        toast(input.type === "text" ? "ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ." : "ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ.", "ğŸ‘ï¸");
      }

      if (t && t.matches("[data-copy]")){
        const sel = t.getAttribute("data-copy");
        const input = $(sel);
        if (!input) return;
        const ok = await copyText(input.value);
        toast(ok ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…" : "ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®.", ok ? "âœ…" : "âš ï¸");
      }
    });

    // Export / Import
    ui.btnExport.addEventListener("click", () => {
      const raw = localStorage.getItem(STORAGE_KEY) || "";
      const blob = new Blob([raw], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_${toLocalISO(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
      toast("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.", "â¬‡ï¸");
    });

    ui.importFile.addEventListener("change", async () => {
      const file = ui.importFile.files && ui.importFile.files[0];
      if (!file) return;

      const text = await file.text();
      try{
        JSON.parse(text); // just to validate
        localStorage.setItem(STORAGE_KEY, text);
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.", "â¬†ï¸");
        setTimeout(() => location.reload(), 600);
      }catch(_){
        toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.", "âš ï¸");
      }finally{
        ui.importFile.value = "";
      }
    });

    // Lock / Unlock UI
    function showModal(){
      ui.modal.hidden = false;
      ui.modalError.hidden = true;
      ui.mp1.value = "";
      ui.mp2.value = "";
      ui.mp1.focus();
    }
    function hideModal(){ ui.modal.hidden = true; }
    ui.modalCancel.addEventListener("click", hideModal);

    function showLockOverlay(){
      ui.lockOverlay.hidden = false;
      ui.unlockError.hidden = true;
      ui.unlockPassword.value = "";
      ui.unlockPassword.focus();
    }
    function hideLockOverlay(){
      ui.lockOverlay.hidden = true;
      ui.unlockError.hidden = true;
      ui.unlockPassword.value = "";
    }

    ui.btnLock.addEventListener("click", async () => {
      // If encryption is on => turn it off (store plain)
      if (encryption.enabled){
        const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø§Ù„Ù‚ÙÙ„ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.");
        if (!ok) return;

        encryption.enabled = false;
        encryption.key = null;
        encryption.saltB64 = null;

        updateLockButton();
        await persist();
        toast("ØªÙ… ÙÙƒ Ø§Ù„Ù‚ÙÙ„. (Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù† Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±)", "ğŸ”“");
        return;
      }

      // Enable encryption
      if (!crypto || !crypto.subtle){
        toast("Ø§Ù„ØªØ´ÙÙŠØ± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.", "âš ï¸");
        return;
      }
      ui.modalTitle.textContent = "ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      ui.modalText.textContent = "Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ© (8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±). Ù„Ø§ ØªÙ†Ø³Ù‡Ø§.";
      showModal();
    });

    ui.modalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const p1 = ui.mp1.value;
      const p2 = ui.mp2.value;
      if (!p1 || p1.length < 8 || p1 !== p2){
        ui.modalError.hidden = false;
        return;
      }

      try{
        const { key, saltB64 } = await deriveKey(p1);
        encryption.enabled = true;
        encryption.key = key;
        encryption.saltB64 = saltB64;

        updateLockButton();
        await persist();
        hideModal();
        toast("ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…", "ğŸ”’");
      }catch(err){
        console.error(err);
        toast("ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„.", "âš ï¸");
      }
    });

    ui.unlockForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      ui.unlockError.hidden = true;
      const pass = ui.unlockPassword.value;

      try{
        const { key } = await deriveKey(pass, lockedBlob.salt);
        const data = await decryptJson(key, lockedBlob.iv, lockedBlob.cipher);

        state = mergeDefaults(data);
        encryption.enabled = true;
        encryption.key = key;
        encryption.saltB64 = lockedBlob.salt;

        lockedBlob = null;
        hideLockOverlay();

        updateLockButton();
        setTab(state.ui.activeTab || "workspaces");
        renderWorkspaces();
        renderVault();
        checkExpiryAlerts();

        toast("ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…", "ğŸ”“");
      }catch(err){
        ui.unlockError.hidden = false;
      }
    });

    // ===== Init =====
    (async function init(){
      // default dates
      ui.wsStart.value = toLocalISO(new Date());
      ui.wsEnd.value = computeExpiry(ui.wsStart.value);

      // Load store
      const raw = loadRaw();

      if (raw && raw.mode === "enc"){
        lockedBlob = raw;
        showLockOverlay();
        updateLockButton(); // shows "Ù‚ÙÙ„" but locked screen anyway
        return;
      }

      if (raw && raw.mode === "plain"){
        state = mergeDefaults(raw.data);
      }else if (raw && raw.data){
        // fallback older shape
        state = mergeDefaults(raw.data);
      }else{
        state = defaultState();
      }

      updateLockButton();
      setTab(state.ui.activeTab || "workspaces");

      renderWorkspaces();
      renderVault();
      checkExpiryAlerts();

      // refresh countdown & alerts periodically (useful Ø¥Ø°Ø§ Ø¨Ù‚Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØªÙˆØ­)
      setInterval(() => {
        renderWorkspaces();
        checkExpiryAlerts();
      }, 10 * 60 * 1000);
    })();
  </script>
</body>
</html>
